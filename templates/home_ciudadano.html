{% extends "base.html" %}
{% load static %}

{% block contenido %}
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
/>
<style>
    .hero-ciudadano {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 45%, #ef9a9a 100%);
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    .hero-ciudadano h1 {
        font-weight: 700;
        color: #7f0000;
    }

    .hero-ciudadano p {
        font-size: 1rem;
        color: #4a4a4a;
    }

    .denuncias-card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.10);
    }

    .denuncias-card .card-header {
        background-color: #c62828;
        color: #fff;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }

    .btn-denuncia {
        background-color: #c62828;
        border: none;
        color: #fff;
        box-shadow: 0 0 10px rgba(198, 40, 40, 0.4);
    }

    .btn-denuncia:hover {
        background-color: #8e0000;
        color: #fff;
    }

    .denuncia-map {
        height: 300px;
        border-radius: 12px;
        box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.15);
    }

    .tabla-denuncias img {
        max-width: 80px;
        border-radius: 6px;
    }

    .imagen-preview {
        max-height: 200px;
        border-radius: 12px;
        object-fit: cover;
    }

    .direccion-ayuda {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .alert-placeholder {
        min-height: 58px;
    }
</style>

<div class="container py-4">
    <div class="hero-ciudadano mb-4">
        <div class="row align-items-center g-3">
            <div class="col-lg-8">
                <h1 class="mb-2">Hola, {{ user.first_name|default:user.username }} </h1>
                <p class="mb-0">
                    Desde aqu铆 puedes reportar microbasurales en tu barrio. Selecciona la ubicaci贸n en el
                    mapa, agrega una descripci贸n y una fotograf铆a opcional. Nuestro equipo municipal har谩 el
                    seguimiento correspondiente.
                </p>
            </div>
            <div class="col-lg-4 text-lg-end text-center">
                <button class="btn btn-denuncia px-4 py-2" data-bs-toggle="modal" data-bs-target="#modalDenuncia">
                    <i class='bx bx-plus-medical me-1'></i> Ingresar Denuncia
                </button>
            </div>
        </div>
    </div>

    <div class="alert-placeholder" id="alertPlaceholder"></div>

    <div class="card denuncias-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Mis denuncias recientes</h5>
            <span class="badge bg-light text-dark" id="totalDenuncias">
                0 registros
            </span>
        </div>
        <div class="card-body">
            <div class="table-responsive tabla-denuncias">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Descripci贸n</th>
                            <th>Direcci贸n</th>
                            <th>Estado</th>
                            <th>Foto</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDenunciasBody"></tbody>
                </table>
            </div>
            <p class="mb-0 text-muted" id="sinDenuncias">
                A煤n no has registrado denuncias. 隆Comienza con el bot贸n "Ingresar Denuncia"!
            </p>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDenuncia" tabindex="-1" aria-labelledby="modalDenunciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background:#c62828; color:#fff;">
                <h5 class="modal-title" id="modalDenunciaLabel">Registrar nueva denuncia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="denunciaForm" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <label for="descripcion" class="form-label">Descripci贸n del problema</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="5" placeholder="Describe qu茅 observaste" required></textarea>

                            <label for="imagen" class="form-label mt-3">Fotograf铆a del microbasural</label>
                            <input class="form-control" type="file" id="imagen" name="imagen" accept="image/*" required>
                            <div id="imagenPreviewWrapper" class="mt-3 d-none">
                                <p class="direccion-ayuda mb-1">Vista previa de la imagen seleccionada</p>
                                <img id="imagenPreview" class="imagen-preview w-100 border" alt="Vista previa de la denuncia">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label" for="buscarDireccion">Busca o ajusta la ubicaci贸n</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="buscarDireccion" placeholder="Buscar direcci贸n (ej: Calle 123, Comuna)">
                                <button class="btn btn-outline-secondary" type="button" id="btnBuscarDireccion">
                                    <i class='bx bx-search-alt-2'></i>
                                </button>
                            </div>
                            <p class="direccion-ayuda mb-2">Puedes escribir una direcci贸n o mover el pin en el mapa para ajustarla.</p>
                            <label for="direccion_textual" class="form-label">Direcci贸n seleccionada</label>
                            <input type="text" class="form-control" id="direccion_textual" name="direccion_textual" placeholder="Selecciona un punto en el mapa" required>
                            <div id="map" class="denuncia-map mt-3"></div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label for="latitud" class="form-label">Latitud</label>
                                    <input type="text" class="form-control" id="latitud" name="latitud" readonly required>
                                </div>
                                <div class="col-md-6">
                                    <label for="longitud" class="form-label">Longitud</label>
                                    <input type="text" class="form-control" id="longitud" name="longitud" readonly required>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-outline-danger mt-2 w-100" type="button" id="btnUbicacion">
                                        <i class='bx bx-current-location me-1'></i> Usar mi ubicaci贸n actual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-denuncia">Guardar denuncia</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formDenuncia = document.getElementById('denunciaForm');
        const alertPlaceholder = document.getElementById('alertPlaceholder');
        const tablaDenunciasBody = document.getElementById('tablaDenunciasBody');
        const modalDenuncia = document.getElementById('modalDenuncia');
        const modal = modalDenuncia && window.bootstrap
            ? new bootstrap.Modal(modalDenuncia)
            : null;
        const totalDenunciasBadge = document.getElementById('totalDenuncias');
        const sinDenunciasMensaje = document.getElementById('sinDenuncias');
        const latitudInput = document.getElementById('latitud');
        const longitudInput = document.getElementById('longitud');
        const direccionInput = document.getElementById('direccion_textual');
        const buscarDireccionInput = document.getElementById('buscarDireccion');
        const btnBuscarDireccion = document.getElementById('btnBuscarDireccion');
        const btnUbicacion = document.getElementById('btnUbicacion');
        const imagenInput = document.getElementById('imagen');
        const imagenPreviewWrapper = document.getElementById('imagenPreviewWrapper');
        const imagenPreview = document.getElementById('imagenPreview');
        const ESTADOS_LABEL = {
            pendiente: 'Pendiente',
            en_proceso: 'En proceso',
            resuelta: 'Resuelta',
        };

        const map = L.map('map').setView([-33.4489, -70.6693], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);

        let marker = null;

        function limpiarPreviewImagen() {
            if (imagenPreviewWrapper) {
                imagenPreviewWrapper.classList.add('d-none');
            }
            if (imagenPreview) {
                imagenPreview.removeAttribute('src');
            }
        }

        if (imagenInput) {
            imagenInput.addEventListener('change', () => {
                const archivo = imagenInput.files && imagenInput.files[0];
                if (!archivo) {
                    limpiarPreviewImagen();
                    return;
                }
                const lector = new FileReader();
                lector.onload = (evento) => {
                    if (imagenPreview) {
                        imagenPreview.src = evento.target?.result || '';
                    }
                    if (imagenPreviewWrapper) {
                        imagenPreviewWrapper.classList.remove('d-none');
                    }
                };
                lector.readAsDataURL(archivo);
            });
        }

        function formatearDireccionDesdeReverse(data) {
            if (!data) {
                return '';
            }
            const address = data.address || {};
            const calle = address.road || address.pedestrian || address.residential || address.path || address.cycleway;
            const numero = address.house_number;
            const comuna = address.city || address.town || address.village || address.municipality || address.county || address.suburb || address.neighbourhood;
            const segmentos = [];
            if (calle) {
                segmentos.push(numero ? `${calle} ${numero}` : calle);
            }
            if (comuna) {
                segmentos.push(comuna);
            }
            if (address.state) {
                segmentos.push(address.state);
            }
            if (!segmentos.length && typeof data.display_name === 'string') {
                return data.display_name;
            }
            return segmentos.join(', ');
        }

        function actualizarCamposCoordenadas(latitud, longitud) {
            if (latitudInput) {
                latitudInput.value = latitud.toFixed(6);
            }
            if (longitudInput) {
                longitudInput.value = longitud.toFixed(6);
            }
        }

        async function actualizarDireccionDesdeCoordenadas(latitud, longitud) {
            if (!direccionInput) {
                return;
            }
            try {
                const respuesta = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitud}&lon=${longitud}&accept-language=es&addressdetails=1`);
                if (!respuesta.ok) {
                    throw new Error('No se pudo obtener la direcci贸n.');
                }
                const data = await respuesta.json();
                const direccionFormateada = formatearDireccionDesdeReverse(data);
                direccionInput.value = direccionFormateada || data.display_name || '';
            } catch (error) {
                console.error(error);
            }
        }

        function posicionarMarcador(lat, lng, { centrar = true, obtenerDireccion = true } = {}) {
            const latitud = Number.parseFloat(lat);
            const longitud = Number.parseFloat(lng);
            if (!Number.isFinite(latitud) || !Number.isFinite(longitud)) {
                return;
            }
            if (marker) {
                marker.setLatLng([latitud, longitud]);
            } else {
                marker = L.marker([latitud, longitud], { draggable: true }).addTo(map);
                marker.on('dragend', (evento) => {
                    const nuevaPosicion = evento.target.getLatLng();
                    posicionarMarcador(nuevaPosicion.lat, nuevaPosicion.lng, { centrar: false, obtenerDireccion: true });
                });
            }
            if (centrar) {
                const zoomActual = map.getZoom();
                map.setView([latitud, longitud], zoomActual < 15 ? 15 : zoomActual);
            }
            actualizarCamposCoordenadas(latitud, longitud);
            if (obtenerDireccion) {
                actualizarDireccionDesdeCoordenadas(latitud, longitud);
            }
        }

        map.on('click', (event) => {
            posicionarMarcador(event.latlng.lat, event.latlng.lng, { obtenerDireccion: true });
        });

        function solicitarGeolocalizacionAutomatica({ mostrarMensajes = false } = {}) {
            if (!navigator.geolocation) {
                if (mostrarMensajes) {
                    mostrarAlerta('Tu navegador no soporta geolocalizaci贸n.', 'warning');
                }
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (posicion) => {
                    const { latitude, longitude } = posicion.coords;
                    posicionarMarcador(latitude, longitude, { obtenerDireccion: true });
                },
                () => {
                    if (mostrarMensajes) {
                        mostrarAlerta('No pudimos obtener tu ubicaci贸n autom谩ticamente. Ajusta el pin manualmente.', 'warning');
                    }
                }
            );
        }

        if (modalDenuncia) {
            modalDenuncia.addEventListener('shown.bs.modal', () => {
                setTimeout(() => {
                    map.invalidateSize();
                    if (!latitudInput?.value || !longitudInput?.value) {
                        solicitarGeolocalizacionAutomatica();
                    }
                }, 200);
            });
            modalDenuncia.addEventListener('hidden.bs.modal', () => {
                if (formDenuncia) {
                    formDenuncia.reset();
                }
                if (direccionInput) {
                    direccionInput.value = '';
                }
                if (buscarDireccionInput) {
                    buscarDireccionInput.value = '';
                }
                if (latitudInput) {
                    latitudInput.value = '';
                }
                if (longitudInput) {
                    longitudInput.value = '';
                }
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
                limpiarPreviewImagen();
            });
        }

        if (btnUbicacion) {
            btnUbicacion.addEventListener('click', () => {
                solicitarGeolocalizacionAutomatica({ mostrarMensajes: true });
            });
        }

        async function buscarDireccionPorTexto(texto) {
            const termino = texto.trim();
            if (!termino) {
                mostrarAlerta('Ingresa una direcci贸n para realizar la b煤squeda.', 'warning');
                return;
            }
            try {
                const respuesta = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&addressdetails=1&q=${encodeURIComponent(termino)}`);
                if (!respuesta.ok) {
                    throw new Error('No se pudo buscar la direcci贸n.');
                }
                const resultados = await respuesta.json();
                if (!Array.isArray(resultados) || resultados.length === 0) {
                    mostrarAlerta('No encontramos coincidencias para esa direcci贸n. Intenta con otra referencia.', 'warning');
                    return;
                }
                const resultado = resultados[0];
                const latitud = Number.parseFloat(resultado.lat);
                const longitud = Number.parseFloat(resultado.lon);
                posicionarMarcador(latitud, longitud, { obtenerDireccion: false });
                if (direccionInput) {
                    const direccionFormateada = formatearDireccionDesdeReverse({
                        address: resultado.address,
                        display_name: resultado.display_name,
                    });
                    direccionInput.value = direccionFormateada || resultado.display_name || termino;
                }
                actualizarDireccionDesdeCoordenadas(latitud, longitud);
            } catch (error) {
                console.error(error);
                mostrarAlerta('Ocurri贸 un problema al buscar la direcci贸n. Intenta nuevamente.', 'danger');
            }
        }

        if (btnBuscarDireccion) {
            btnBuscarDireccion.addEventListener('click', () => {
                if (buscarDireccionInput) {
                    buscarDireccionPorTexto(buscarDireccionInput.value || '');
                }
            });
        }

        if (buscarDireccionInput) {
            buscarDireccionInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    buscarDireccionPorTexto(buscarDireccionInput.value || '');
                }
            });
        }

        function mostrarAlerta(mensaje, tipo = 'success') {
            alertPlaceholder.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function formatearEstado(denuncia) {
            if (denuncia.estado_display) {
                return denuncia.estado_display;
            }
            return ESTADOS_LABEL[denuncia.estado] || denuncia.estado;
        }

        function agregarDenunciaATabla(denuncia, { prepend = true } = {}) {
            if (!tablaDenunciasBody) {
                return;
            }
            const fila = document.createElement('tr');
            fila.dataset.denunciaId = denuncia.id;
            const latitud = Number.parseFloat(denuncia.latitud);
            const longitud = Number.parseFloat(denuncia.longitud);
            const latitudTexto = Number.isFinite(latitud) ? latitud.toFixed(6) : '--';
            const longitudTexto = Number.isFinite(longitud) ? longitud.toFixed(6) : '--';
            const direccion = denuncia.direccion_textual || 'Sin direcci贸n disponible';
            fila.innerHTML = `
                <td>${new Date(denuncia.fecha_creacion).toLocaleString('es-CL')}</td>
                <td>${denuncia.descripcion}</td>
                <td><strong>${direccion}</strong><br><small>Lat: ${latitudTexto}<br>Lng: ${longitudTexto}</small></td>
                <td><span class="badge text-bg-light">${formatearEstado(denuncia)}</span></td>
                <td>${denuncia.imagen ? `<img src="${denuncia.imagen}" alt="Foto denuncia">` : '<span class="text-muted">Sin imagen</span>'}</td>
            `;
            if (prepend) {
                tablaDenunciasBody.prepend(fila);
            } else {
                tablaDenunciasBody.appendChild(fila);
            }
            if (sinDenunciasMensaje) {
                sinDenunciasMensaje.classList.add('d-none');
            }
            if (totalDenunciasBadge) {
                const total = tablaDenunciasBody.querySelectorAll('tr').length;
                totalDenunciasBadge.textContent = `${total} registro${total !== 1 ? 's' : ''}`;
            }
        }

        async function cargarDenuncias() {
            if (!tablaDenunciasBody) {
                return;
            }

            try {
                const respuesta = await fetch('/api/denuncias/mis/', {
                    credentials: 'include',
                });

                if (!respuesta.ok) {
                    throw new Error('No se pudieron obtener tus denuncias.');
                }

                const data = await respuesta.json();

                tablaDenunciasBody.innerHTML = '';

                if (!data || data.length === 0) {
                    if (sinDenunciasMensaje) {
                        sinDenunciasMensaje.classList.remove('d-none');
                    }
                    if (totalDenunciasBadge) {
                        totalDenunciasBadge.textContent = '0 registros';
                    }
                    return;
                }

                data.forEach((denuncia) => agregarDenunciaATabla(denuncia, { prepend: false }));
            } catch (error) {
                console.error(error);
                mostrarAlerta('No se pudieron cargar tus denuncias. Intenta nuevamente.', 'danger');
            }
        }

        async function enviarDenuncia() {
            if (!formDenuncia) {
                return;
            }

            const latitud = latitudInput ? latitudInput.value.trim() : '';
            const longitud = longitudInput ? longitudInput.value.trim() : '';
            const direccionSeleccionada = direccionInput ? direccionInput.value.trim() : '';
            const archivoSeleccionado = imagenInput && imagenInput.files ? imagenInput.files[0] : null;

            if (!archivoSeleccionado) {
                mostrarAlerta('Debes adjuntar una fotograf铆a del microbasural.', 'danger');
                return;
            }

            if (!direccionSeleccionada) {
                mostrarAlerta('Debes indicar una direcci贸n para la denuncia.', 'danger');
                return;
            }

            if (!latitud || !longitud) {
                mostrarAlerta('Debes seleccionar una ubicaci贸n en el mapa.', 'danger');
                return;
            }

            const formData = new FormData(formDenuncia);
            formData.set('latitud', latitud);
            formData.set('longitud', longitud);
            formData.set('direccion_textual', direccionSeleccionada);
            const csrfToken = formDenuncia.querySelector('input[name="csrfmiddlewaretoken"]').value;

            try {
                const respuesta = await fetch('/api/denuncias/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    body: formData,
                    credentials: 'include',
                });

                if (!respuesta.ok) {
                    const errorData = await respuesta.json().catch(() => ({}));
                    let mensajeError = errorData?.detail;
                    if (!mensajeError && errorData && typeof errorData === 'object') {
                        const firstErrorKey = Object.keys(errorData)[0];
                        if (firstErrorKey) {
                            const rawError = errorData[firstErrorKey];
                            if (Array.isArray(rawError) && rawError.length > 0) {
                                mensajeError = rawError[0];
                            } else if (typeof rawError === 'string') {
                                mensajeError = rawError;
                            }
                        }
                    }
                    if (!mensajeError) {
                        mensajeError = 'No se pudo registrar la denuncia. Revisa los datos ingresados.';
                    }
                    mostrarAlerta(mensajeError, 'danger');
                    return;
                }

                const data = await respuesta.json();
                agregarDenunciaATabla(data);
                formDenuncia.reset();
                if (direccionInput) {
                    direccionInput.value = '';
                }
                if (buscarDireccionInput) {
                    buscarDireccionInput.value = '';
                }
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
                if (latitudInput) {
                    latitudInput.value = '';
                }
                if (longitudInput) {
                    longitudInput.value = '';
                }
                limpiarPreviewImagen();
                if (modal) {
                    modal.hide();
                }
                mostrarAlerta('隆Denuncia registrada correctamente! Puedes verla en la tabla inferior.');
            } catch (error) {
                console.error(error);
                mostrarAlerta('Ocurri贸 un error inesperado. Int茅ntalo nuevamente.', 'danger');
            }
        }

        if (formDenuncia) {
            formDenuncia.addEventListener('submit', (event) => {
                event.preventDefault();
                enviarDenuncia();
            });
        }

        cargarDenuncias();
    });
</script>
{% endblock %}
